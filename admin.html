<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆë‹ˆë˜ ê´€ë¦¬ì</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 20px; }
        h1 { font-size: 24px; }
        button { padding: 10px; margin-top: 10px; }
        textarea { width: 100%; height: 200px; margin-top: 10px; }
        .box { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<h1>ë§ˆë‹ˆë˜ ê´€ë¦¬ì í˜ì´ì§€</h1>

<button onclick="runMatching()">ğŸ”€ ëœë¤ ë§¤ì¹­ ì‹¤í–‰</button>
<button onclick="loadParticipants()">ğŸ‘¥ ì°¸ê°€ì ì¡°íšŒ</button>
<button onclick="loadMessages()">ğŸ’¬ ì „ì²´ ë©”ì‹œì§€ ì¡°íšŒ</button>

<div id="output" class="box"></div>

<!-- Firebase v8 ë²„ì „ -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCo0eAyu6iaqSxd0zCCYKgc9tjrLsJUIvo",
      authDomain: "manitto3-e0164.firebaseapp.com",
      databaseURL: "https://manitto3-e0164-default-rtdb.firebaseio.com",
      projectId: "manitto3-e0164",
      storageBucket: "manitto3-e0164.firebasestorage.app",
      messagingSenderId: "97931219910",
      appId: "1:97931219910:web:4ad27aae6fef4b6024d8c7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ëœë¤ ë§¤ì¹­ ì‹¤í–‰ */
    async function runMatching() {
        const snap = await db.collection("participants").get();
        let arr = [];

        snap.forEach(doc => {
            arr.push({ code: doc.id, ...doc.data() });
        });

        let shuffled = [...arr].sort(() => Math.random() - 0.5);

        for (let i = 0; i < arr.length; i++) {
            const giver = arr[i];
            const receiver = shuffled[(i + 1) % arr.length];

            await db.collection("participants").doc(giver.code).update({
                matched_to: receiver.name
            });
        }

        alert("ëœë¤ ë§¤ì¹­ ì™„ë£Œ!");
    }

    /* ì°¸ê°€ì ì¡°íšŒ */
    async function loadParticipants() {
        const snap = await db.collection("participants").get();
        let html = "<h3>ì°¸ê°€ì ë¦¬ìŠ¤íŠ¸</h3>";

        snap.forEach(doc => {
            const d = doc.data();
            html += `<div><b>${d.name}</b> (ì½”ë“œ: ${doc.id}) â†’ ${d.matched_to || "X"}</div>`;
        });

        document.getElementById("output").innerHTML = html;
    }

    /* ì „ì²´ ë©”ì‹œì§€ ì¡°íšŒ */
    async function loadMessages() {
        const snap = await db.collection("messages").orderBy("time").get();
        let html = "<h3>ì „ì²´ ë©”ì‹œì§€</h3>";

        snap.forEach(doc => {
            const d = doc.data();
            html += `<div> <b>${d.from}</b> â†’ <b>${d.to}</b>: ${d.text}</div>`;
        });

        document.getElementById("output").innerHTML = html;
    }
</script>

</body>
</html>
