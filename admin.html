<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>관리자 페이지</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>

<style>
    body {
        font-family: 'Pretendard', sans-serif;
        margin: 0; background: #f5f6fa;
    }

    h2 { margin: 10px 0; }

    .container {
        max-width: 1200px;
        margin: 20px auto;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    textarea {
        width: 100%;
        height: 120px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        resize: none;
        margin-bottom: 10px;
        font-size: 14px;
    }

    button {
        padding: 10px 16px;
        background: #4c75f2;
        border: none;
        color: #fff;
        border-radius: 8px;
        cursor: pointer;
        margin: 3px 0;
        font-size: 14px;
    }
    button:hover { background: #3d63cc; }

    .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .list {
        background: #f1f2f6;
        padding: 10px;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
        font-size: 14px;
    }

    .participant-item {
        padding: 8px;
        background: #fff;
        margin-bottom: 6px;
        border-radius: 6px;
        cursor: pointer;
        border: 1px solid #ddd;
    }
    .participant-item:hover {
        background: #eef3ff;
    }

    .msg-box {
        background: #fff;
        border-radius: 8px;
        padding: 10px;
        border: 1px solid #ddd;
        margin-bottom: 8px;
    }

</style>
</head>
<body>

<div class="container">

    <h2>참가자 등록</h2>
    <textarea id="names" placeholder="한 줄에 한 명씩 입력하세요"></textarea>
    <button onclick="registerParticipants()">참가자 등록</button>
    <button onclick="deleteAllParticipants()" style="background:#d9534f">전체 삭제</button>

    <hr>

    <h2>랜덤 매칭</h2>
    <button onclick="doMatching()">랜덤 매칭 실행</button>

    <hr>

    <h2>참가자 목록</h2>
    <div class="list" id="participantsList">불러오는 중...</div>

    <hr>

    <h2>메시지함 (특정 참가자 선택)</h2>
    <div class="list" id="messagesList">참가자를 선택하세요.</div>

    <hr>

    <h2>전체 메시지 조회</h2>
    <button onclick="loadAllMessages()">전체 메시지 불러오기</button>
    <div class="list" id="allMessages">전체 메시지를 불러오세요.</div>

</div>


<script>
/* ---------- Firebase 초기화 ---------- */
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "manitto3-e0164.firebaseapp.com",
    projectId: "manitto3-e0164",
    storageBucket: "manitto3-e0164.appspot.com",
    messagingSenderId: "176237527550",
    appId: "1:176237527550:web:xxxxxxxxxx"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* --------------------------------------------- */
/*  1. 4자리 숫자 코드 생성 (1000~9999)          */
/* --------------------------------------------- */
function generateCode() {
    return Math.floor(1000 + Math.random() * 9000).toString();
}

/* -------------------------------------------------------- */
/*   2. 참가자 등록 (누락 방지: await 보장)                 */
/* -------------------------------------------------------- */
async function registerParticipants() {
    const raw = document.getElementById("names").value.trim();
    if (!raw) return alert("이름을 입력하세요!");

    const names = raw.split("\n").map(n => n.trim()).filter(n => n);

    for (let name of names) {
        let code = generateCode();
        while ((await db.collection("participants").doc(code).get()).exists) {
            code = generateCode();
        }

        await db.collection("participants").doc(code).set({
            name: name,
            matched_to: ""
        });
    }

    alert("등록 완료!");
    loadParticipants();
}

/* -------------------------------------------------------- */
/*  3. 전체 참가자 불러오기                                 */
/* -------------------------------------------------------- */
async function loadParticipants() {
    const box = document.getElementById("participantsList");
    box.innerHTML = "불러오는 중...";

    const snap = await db.collection("participants").get();

    let html = "";
    snap.forEach(doc => {
        const p = doc.data();
        html += `
            <div class="participant-item" onclick="loadMessages('${doc.id}', '${p.name}')">
                <b>${p.name}</b> (${doc.id})
                <br>→ ${p.matched_to || "없음"}
            </div>
        `;
    });

    box.innerHTML = html || "참가자가 없습니다.";
}

/* -------------------------------------------------------- */
/*  4. 랜덤 매칭 (DB에 영구 저장 → 새로고침해도 유지)        */
/* -------------------------------------------------------- */
async function doMatching() {
    const snap = await db.collection("participants").get();
    let list = snap.docs.map(doc => ({ code: doc.id, ...doc.data() }));

    if (list.length < 2) return alert("2명 이상 필요합니다!");

    // 셔플
    for (let i = list.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [list[i], list[j]] = [list[j], list[i]];
    }

    // 순환 매칭
    for (let i = 0; i < list.length; i++) {
        const giver = list[i].code;
        const receiver = list[(i + 1) % list.length].code;
        await db.collection("participants").doc(giver).update({ matched_to: receiver });
    }

    alert("매칭 완료!");
    loadParticipants();
}

/* -------------------------------------------------------- */
/*  5. 특정 참가자 메시지 불러오기                           */
/* -------------------------------------------------------- */
async function loadMessages(code, name) {
    const box = document.getElementById("messagesList");
    box.innerHTML = `${name}님의 메시지를 불러오는 중...`;

    const snap = await db
        .collection("participants")
        .doc(code)
        .collection("messages")
        .orderBy("time", "asc")
        .get();

    if (snap.empty) {
        box.innerHTML = "메시지가 없습니다.";
        return;
    }

    let html = "";
    snap.forEach(doc => {
        const m = doc.data();
        html += `
            <div class="msg-box">
                <b>${m.from}</b> → <b>${m.to}</b><br>
                ${m.text}<br>
                <small>${m.time}</small>
            </div>
        `;
    });

    box.innerHTML = html;
}

/* -------------------------------------------------------- */
/*  6. 전체 메시지 불러오기                                  */
/* -------------------------------------------------------- */
async function loadAllMessages() {
    const box = document.getElementById("allMessages");
    box.innerHTML = "불러오는 중...";

    const participants = await db.collection("participants").get();
    let all = [];

    for (let doc of participants.docs) {
        const code = doc.id;

        const msgs = await db
            .collection("participants")
            .doc(code)
            .collection("messages")
            .orderBy("time", "asc")
            .get();

        msgs.forEach(m => {
            all.push(m.data());
        });
    }

    if (all.length === 0) {
        box.innerHTML = "메시지가 없습니다.";
        return;
    }

    all.sort((a, b) => a.time - b.time);

    let html = "";
    all.forEach(m => {
        html += `
            <div class="msg-box">
                <b>${m.from}</b> → <b>${m.to}</b><br>
                ${m.text}<br>
                <small>${m.time}</small>
            </div>
        `;
    });

    box.innerHTML = html;
}

/* -------------------------------------------------------- */
/*  7. 전체 삭제                                              */
/* -------------------------------------------------------- */
async function deleteAllParticipants() {
    if (!confirm("정말 삭제할까요?")) return;

    const snap = await db.collection("participants").get();
    for (let doc of snap.docs) {
        await db.collection("participants").doc(doc.id).delete();
    }

    document.getElementById("participantsList").innerHTML = "삭제됨";
}
</script>
</body>
</html>
